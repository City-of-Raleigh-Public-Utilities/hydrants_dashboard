"use strict";angular.module("hydrantsDashboard",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ngStorage","agsserver","leaflet-directive","cgBusy","ngCsv"]).constant("FIREDEPTS",[{name:"City of Raleigh Fire Department",title:"Raleigh",icon:"images/Raleigh_Fire_Department_Logo.png"},{name:"Town of Garner Fire Department",title:"Garner",icon:"images/garner.png"},{name:"Town of Wake Forest Fire Department",title:"Wake Forest",icon:"images/wakeforest_logo.jpg"},{name:"Town of Zebulon Fire Department",title:"Zebulon",icon:"images/ZFD Patch.jpg"},{name:"Town of Knightdale Fire Department",title:"Knightdale",icon:"images/kdaleseal.png"},{name:"Town of Wendell Fire Department",title:"Wendell",icon:"images/wendellfire6.jpg"},{name:"Town of Rolesville Fire Department",title:"Rolesville",icon:"images/firehydrant-assets/scaled-at-25/Layer 1.png"},{name:"Wake-New Hope",title:"Wake-New Hope",icon:"images/WakeNewHopePatch.png"},{name:"Eastern Wake Fire Department",title:"Eastern Wake",icon:"images/easternwake.png"}]).config(["$routeProvider","$httpProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/responseZone/:zone",{templateUrl:"views/responsezone.html",controller:"ResponsezoneCtrl"}).when("/contact",{templateUrl:"views/contacts.html",controller:"ContactsCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("hydrantsDashboard").controller("MainCtrl",["$anchorScroll","$location","$scope","FIREDEPTS",function(a,b,c,d){c.departments=d,c.gotoAnchor=function(){var c="stations";b.hash()!==c?b.hash("stations"):a()}}]),angular.module("hydrantsDashboard").controller("AboutCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("hydrantsDashboard").factory("agsFactory",["Ags","$http","$q","$localStorage","$location",function(a,b,c,d,e){var f=(new a({host:"maps.raleighnc.gov",protocol:"https"}),new a({host:"mapstest.raleighnc.gov",protocol:"http"})),g={login:function(a,b){return f.requestToken(a,b,60)},isTokenValid:function(a){var b=new Date;return a>b?!0:(e.path("/"),!1)},publicUtilMS:f.setService({folder:"PublicUtility",service:"HydrantInspection",server:"MapServer"}),publicUtilFS:f.setService({folder:"PublicUtility",service:"HydrantInspection",server:"FeatureServer"})};return g}]),angular.module("hydrantsDashboard").controller("ResponsezoneCtrl",["$scope","$route","$routeParams","$location","FIREDEPTS","agsFactory","leafletData","$filter","$interval","hydrantStats","hydrantEvents","$timeout","$localStorage","icons",function(a,b,c,d,e,f,g,h,i,j,k,l,m){a.$routeParams=c,f.isTokenValid(m.expires),a.token=m.token,a.responseZone=c.zone,e.forEach(function(b){b.title===a.responseZone&&(a.badge=b.icon)}),angular.extend(a,{defaults:{zoomControl:!1},layers:{baselayers:{osm:{name:"OpenStreetMap",url:"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",type:"xyz",layerParams:{},layerOptions:{}}},overlays:{Hydrants:{name:"Hydrants",type:"dynamic",url:"http://mapstest.raleighnc.gov/arcgis/rest/services/PublicUtility/HydrantInspection/MapServer",visible:!0,layerParams:{token:a.token},layerOptions:{layers:[1],opacity:.5,attribution:"Copyright:Â© 2015 City of Raleigh",position:"back"}}}}});var n=new L.FeatureGroup,o=new L.FeatureGroup;a.selectedHydrant={},a.hydrantRef={},a.mapFilterOptions=k.filters,a.mapFilterSelection=k.filters[0],a.updateFilter=function(){angular.extend(a,{geojson:{data:a.geojson.data,pointToLayer:function(a,b){return L.circleMarker(b,k.setHydrantStyle)},style:a.mapFilterSelection.style,resetStyleOnMouseout:!0},legend:a.mapFilterSelection.legend})},i(function(){a.today=h("date")(new Date,"short")},1e3);var p={serviceArea:{layer:"RPUD.CombinedFireResponse",headers:{"Content-Type":"application/x-www-form-urlencoded"},geojson:!0,actions:"query",params:{token:a.token,f:"json",text:a.responseZone,outSR:4326}},hydrants:{layer:"RPUD.wHydrant",geojson:!0,actions:"query",headers:{"Content-Type":"application/x-www-form-urlencoded"},params:{token:a.token,f:"json",geometryType:"esriGeometryPolygon",outFields:"STNUM, ISSUE1, ISSUE2, SERVICEDBY, FLOWDATE, STENUM, STPREFIX, STNAME, STTYPE, STSUFFIX, OWNEDBY, MANUFACTURER, HYDRANTYEAR, VALVESIZE, PUMPERNOZZLETYPE, SIDENOZZLETYPE, OPERABLE, REPAIRNEED, NOTES, RFD_NOTES, FACILITYID, CHECKED, JURISID, RFDSTATION, EDITEDON, CREATEDON",inSR:4326,outSR:4326,spatialRel:"esriSpatialRelContains"}}};g.getMap().then(function(b){a.$on("leafletDirectiveMap.geojsonMouseover",function(b,c,d){a.selectedHydrant=k.hydrantMouseover(c,d)}),a.$on("leafletDirectiveMap.geojsonClick",function(a,b){k.zoomToFeature(b)}),a.zoomToFeature=function(c){o.clearLayers(),a.selectedHydrant.properties?a.selectedHydrant.properties=c.attributes:(a.selectedHydrant={},a.selectedHydrant.properties=c.attributes),b.setView([c.geom.coordinates[1],c.geom.coordinates[0]],18);var d=L.circleMarker([c.geom.coordinates[1],c.geom.coordinates[0]]);d.setStyle({radius:16,fillColor:"#00ffe6",color:"#000",weight:1,opacity:1,fillOpacity:.8}),o.addLayer(d),o.addTo(b),o.bringToBack()},a.clearFeature=function(){o.clearLayers()},a.searchMap=function(c,d,e){a.searchPromise=l(function(){e.data.features=h("filter")(a.hydrantRef.features,{$:d}),angular.extend(a,{geojson:{data:e.data,pointToLayer:function(a,b){return L.circleMarker(b,k.setHydrantStyle)},style:k.setHydrantStyle,resetStyleOnMouseout:!0}}),n.clearLayers();var c=turf.envelope(e.data);L.geoJson(c,{onEachFeature:function(a,b){n.addLayer(b)}}),b.fitBounds(n.getBounds())},500)}}),a.serviceAreas,f.publicUtilMS.request(p.serviceArea).then(function(b){a.serviceAreas=turf.combine(b);var c=turf.simplify(b.features[0],.02,!0),d=Terraformer.ArcGIS.convert(c.geometry);return n.clearLayers(),g.getMap().then(function(b){L.geoJson(a.serviceAreas,{style:{fillColor:"rgba(50, 173, 2, 0.74)",weight:2,opacity:1,color:"#fff",dashArray:"3",fillOpacity:.7},onEachFeature:function(a,b){n.addLayer(b)}}).addTo(b),b.fitBounds(n.getBounds());var c=L.Control.zoomHome();c.addTo(b)}),d},function(){console.log("Error: Cannot retrieve response zones")}).then(function(b){p.hydrants.params.geometry=b,a.hydrantPromise=f.publicUtilFS.request(p.hydrants),a.hydrantPromise.then(function(b){console.log(b);try{if("object"!=typeof b)throw{error:"Please login"}}catch(c){return void console.log(c)}angular.copy(b,a.hydrantRef),angular.extend(a,{geojson:{data:b,pointToLayer:function(a,b){return L.circleMarker(b,k.setHydrantStyle)},style:a.mapFilterSelection.style,resetStyleOnMouseout:!0},legend:a.mapFilterSelection.legend}),j.getReport(b.features,function(b){a.reportTotals=b,a.needsRepair=[{status:!0,data:b.needsRepairPublic,name:"Needs Repair Public"},{status:!1,data:b.needsRepairPrivate,name:"Needs Repair Private"}],a.selected=a.needsRepair[0],a.needsRepair[0].data[0]&&(a.headers=Object.keys(a.needsRepair[0].data[0].attributes)),a.printCSV=function(a){var b=[];return a.forEach(function(a){b.push(a.attributes)}),b}})},function(){console.log("Error: Cannot retrieve hydrants")})},function(){console.log("Error: Cannot retrieve districts")}),a.$watch("reportTotals",function(){}),a.$watch("needsRepair",function(){})}]),angular.module("hydrantsDashboard").controller("ContactsCtrl",["$scope",function(){}]),angular.module("hydrantsDashboard").factory("hydrantStats",["$filter","agsFactory","$localStorage",function(a,b,c){var d=c.token,e=new Date;e.setHours(0),e.setMinutes(0),e.setMilliseconds(0);var f=new Date(2015,4,1,0,0,0),g={daily:{Checked:0,Inoperable:0,Need_Repair:0,New_Hydrants:0},total:{Checked_Public:0,Checked_Private:0,Inoperable_Public:0,Inoperable_Private:0,Need_Repair_Public:0,Need_Repair_Private:0,New_Hydrant_Public:0,New_Hydrant_Private:0},needsRepairPublic:[],needsRepairPrivate:[]},h={report:{daily:{Checked:0,Inoperable:0,Need_Repair:0,New_Hydrants:0},total:{Checked_Public:0,Checked_Private:0,Inoperable_Public:0,Inoperable_Private:0,Need_Repair_Public:0,Need_Repair_Private:0,New_Hydrant_Public:0,New_Hydrant_Private:0},needsRepairPublic:[],needsRepairPrivate:[]},getReport:function(a,b){var c=this;this.report=angular.copy(g),a.forEach(function(a){var b=a.properties;a.properties.EDITEDON>e.getTime()&&("Y"===b.CHECKED?c.report.daily.Checked++:0,"N"===b.OPERABLE?c.report.daily.Inoperable++:0,"1"===b.REPAIRNEED?c.report.daily.Need_Repair++:0,b.CREATEDON>=e.getTime()?c.report.daily.New_Hydrants++:0),"Y"===b.CHECKED&&0===b.OWNEDBY&&null!==b.RFDSTATION?c.report.total.Checked_Public++:0,"Y"===b.CHECKED&&1===b.OWNEDBY&&null!==b.RFDSTATION?c.report.total.Checked_Private++:0,"N"===b.OPERABLE&&0===b.OWNEDBY&&null!==b.RFDSTATION?c.report.total.Inoperable_Public++:0,"N"===b.OPERABLE&&1===b.OWNEDBY&&null!==b.RFDSTATION?c.report.total.Inoperable_Private++:0,1===b.REPAIRNEED&&0===b.OWNEDBY&&null!==b.RFDSTATION?(c.report.total.Need_Repair_Public++,c.report.needsRepairPublic.push({attributes:b,geom:a.geometry})):0,1===b.REPAIRNEED&&1===b.OWNEDBY&&null!==b.RFDSTATION?(c.report.total.Need_Repair_Private++,c.report.needsRepairPrivate.push({attributes:b,geom:a.geometry})):0,b.CREATEDON>=f.getTime()&&0===b.OWNEDBY&&null!==b.RFDSTATION?c.report.total.New_Hydrant_Public++:0,b.CREATEDON>=f.getTime()&&1===b.OWNEDBY&&null!==b.RFDSTATION?c.report.total.New_Hydrant_Private++:0}),b(this.report)},getCheckedStats:function(a){var c=(new Date).getTime(),e={layer:"Fire Hydrants",geojson:!1,actions:"query",headers:{"Content-Type":"application/x-www-form-urlencoded"},params:{token:d,f:"json",where:"RFDSTATION IS NOT NULL AND CHECKED = 'Y' AND "+c+" = "+c,returnGeometry:!1,geometryType:"esriGeometryPolygon",spatialRel:"esriSpatialRelContains",geometry:a,outStatistics:[{statisticType:"count",onStatisticField:"CHECKED",outStatisticFieldName:"count"}],groupByFieldsForStatistics:"OWNEDBY"}};return b.publicUtilFS.request(e)}};return h}]),angular.module("hydrantsDashboard").directive("totalsTable",["$filter",function(){return{templateUrl:"views/totals-table.html",restrict:"E",transclude:!0,scope:{data:"=",title:"=",view:"="},link:function(a){a.defaultTitle=a.view?"FACILITYID: ":"Hydrant Totals for "}}}]),angular.module("hydrantsDashboard").factory("hydrantEvents",["leafletData",function(a){var b={filters:[{name:"Checked",style:function(a){switch(a.properties.CHECKED){case"N":return{fillColor:"#ff0000",color:"#000",weight:1,opacity:1,fillOpacity:.8,radius:4};case"Y":return{fillColor:"#0008ff",color:"#000",weight:1,opacity:1,fillOpacity:.8,radius:4}}},legend:{position:"bottomleft",colors:["#0008ff","#ff0000"],labels:["Checked","Not Checked"]},counts:[0,0]},{name:"Repairs",style:function(a){switch(a.properties.REPAIRNEED){case 0:return{fillColor:"#0008ff",color:"#000",weight:1,opacity:1,fillOpacity:.8,radius:4};case 1:return{fillColor:"#ff0000",color:"#000",weight:1,opacity:1,fillOpacity:.8,radius:4}}},legend:{position:"bottomleft",colors:["#ff0000","#0008ff"],labels:["Repair Needed","No Repair Needed"]}},{name:"Operable",style:function(a){switch(a.properties.OPERABLE){case"Y":return{fillColor:"#0008ff",color:"#000",weight:1,opacity:1,fillOpacity:.8,radius:4};case"N":return{fillColor:"#ff0000",color:"#000",weight:1,opacity:1,fillOpacity:.8,radius:4}}},legend:{position:"bottomleft",colors:["#0008ff","#ff0000"],labels:["Operable","Not Operable"]}}],setHydrantStyle:function(a){switch(a.properties.REPAIRNEED){case 0:return{fillColor:"#0008ff",color:"#000",weight:1,opacity:1,fillOpacity:.8,radius:4};case 1:return{fillColor:"#ff0000",color:"#000",weight:1,opacity:1,fillOpacity:.8,radius:4}}},hydrantMouseover:function(a,b){var c=b.target;return c.setStyle({radius:6,fillColor:"#00ffe6",color:"#000",weight:1,opacity:1,fillOpacity:.8}),c.bringToFront(),a},zoomToFeature:function(b){a.getMap().then(function(a){var c=[b.geometry.coordinates[1],b.geometry.coordinates[0]];a.setView(c,18)})}};return b}]),angular.module("hydrantsDashboard").directive("loginForm",["agsFactory","$location","$localStorage",function(a,b,c){return{restrict:"E",templateUrl:"views/login-form.html",controller:["$scope",function(d){d.token="",d.loggedIn=!0,d.login=function(e,f){var g={username:e,password:f,expiration:60,f:"json"};a.login(g).then(function(a){d.token=a,d.loggedIn=a,c.token=a.token,c.expires=a.expires,a&&d.modal.modal("hide")},function(){b.url("/")})}}],link:function(b,d){b.status=a.isTokenValid(c.expires),b.status||(b.modal=$(".modal",d[0]),b.modal.modal({keyboard:!1,backdrop:"static"}))}}}]),angular.module("hydrantsDashboard").factory("icons",function(){var a={defaultIcon:{},"public":{iconUrl:"../images/firehydrant-assets/scaled-at-25/Layer 1.png",iconSize:[15,30]},"private":{iconUrl:"../images/firehydrant-assets-private/scaled-at-25/Layer 1.png",iconSize:[15,30]},publicTrue:{iconUrl:"../images/firehydrant-assets-public-true/scaled-at-25/Layer 1.png",iconSize:[15,30]},publicFalse:{iconUrl:"../images/firehydrant-assets-public-false/scaled-at-25/Layer 1.png",iconSize:[15,30]},privateTrue:{iconUrl:"../images/firehydrant-assets-private-green/scaled-at-25/Layer 1.png",iconSize:[15,30]},privateFalse:{iconUrl:"../images/firehydrant-assets-private-false/scaled-at-25/Layer 1.png",iconSize:[15,30]}};return a});